<!DOCTYPE html>

<html>
<head>
  <title>pubnub-angular.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PZWSZ2"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-PZWSZ2');</script>
  <!-- End Google Tag Manager -->
    <div id="container">
    <div id="background"></div>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>pubnub-angular.coffee</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Annotated Source Code for the PubNub AngularJS library.
Welcome! Thank you for reading this documentation - if you have any feedback or suggestions, please file a GitHub issue and we’ll take a look right away!</p>
<p>Using this library should be as easy as:</p>
<ol>
<li>Install the library using <code>bower install pubnub-angular</code></li>
<li>Include the JS libraries for pubnub and pubnub-angular into your HTML using SCRIPT tags</li>
<li>Declare a dependency on “pubnub.angular.service” in your application’s Angular module</li>
<li>Inject the PubNub service object into your AngularJS services and controllers as you see fit!</li>
</ol>
<p>For step-by-step instructions, check out <a href="https://github.com/pubnub/pubnub-angular/blob/master/README.md">https://github.com/pubnub/pubnub-angular/blob/master/README.md</a></p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>We love strict mode.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-string">'use strict'</span></pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Set up an Angular <a href="https://docs.angularjs.org/guide/module">module</a>. Notice the identifier <code>pubnub.angular.service</code>, used when declaring a <a href="https://docs.angularjs.org/guide/di">dependency</a> on the PubNub Angular library.</p>

            </div>

            <div class="content"><div class='highlight'><pre>angular.<span class="hljs-built_in">module</span>(<span class="hljs-string">'pubnub.angular.service'</span>, [])</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Set up a factory for injecting a <code>PubNub</code> service into your Angular Controller or Service. Depends on the Angular <a href="https://docs.angularjs.org/api/ng/service/$rootScope">$rootScope</a> so that the PubNub object is persistent across controller instantiations.</p>

            </div>

            <div class="content"><div class='highlight'><pre>  .factory <span class="hljs-string">'PubNub'</span>, [<span class="hljs-string">'$rootScope'</span>, <span class="hljs-string">'$q'</span>, <span class="hljs-string">'$timeout'</span>, <span class="hljs-function"><span class="hljs-params">($rootScope, $q, $timeout)</span> -&gt;</span></pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Initialize an object for the PubNub service’s data. Set the current version, instance, channels, presence, and jsapi for advanced access.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c = {</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Our current version of this PubNub Angular library</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">'VERSION'</span>   : <span class="hljs-string">'1.2.0-beta.1'</span></pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>A reference to the PubNub vanilla JavaScript API object (aka PUBNUB from <a href="https://github.com/pubnub/javascript/blob/master/web/pubnub.js">https://github.com/pubnub/javascript/blob/master/web/pubnub.js</a>)</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">'_instance'</span> : <span class="hljs-literal">null</span></pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The list of channels that we currently know about</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">'_channels'</span> : []</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>A map of channel name to channel members that we currently know about</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">'_presence'</span> : {}</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>A map of references to vanilla JavaScript API functions for advanced client usage</p>

            </div>

            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">'jsapi'</span>       : {}
    }</pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Include the “map” and “each” functions into the PubNub Angular API as helper functions.
We create and invoke a closure to capture both the angular context method name into the helper function.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> [<span class="hljs-string">'map'</span>, <span class="hljs-string">'each'</span>]
      <span class="hljs-keyword">if</span> PUBNUB?[k] <span class="hljs-keyword">instanceof</span> Function
        <span class="hljs-function"><span class="hljs-params">((kk) -&gt; c[kk] = -&gt;
          c[<span class="hljs-string">'_instance'</span>]?[kk].apply c[<span class="hljs-string">'_instance'</span>], arguments)(k)</span>

</span></pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Add bindings to the original vanilla JavaScript PubNub API methods under the “jsapi” key.
We create and invoke a closure to capture both the angular context method name into the helper function.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">of</span> PUBNUB
      <span class="hljs-keyword">if</span> PUBNUB?[k] <span class="hljs-keyword">instanceof</span> Function
        <span class="hljs-function"><span class="hljs-params">((kk) -&gt; c[<span class="hljs-string">'jsapi'</span>][kk] = -&gt;
          c[<span class="hljs-string">'_instance'</span>]?[kk].apply c[<span class="hljs-string">'_instance'</span>], arguments)(k)</span>

</span></pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Add a field so that clients can tell the library has been initialized.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">initialized</span> = -&gt;</span> !!c[<span class="hljs-string">'_instance'</span>]</pre></div></div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><a href="http://www.pubnub.com/docs/javascript/api/reference.html#init">Initialize</a> the PubNub Client API. You must do this before trying to use the API to establish account credentials. Overwrites the current state, so this method should only be called once when instantiating an Angular application.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">init</span> = -&gt;</span>
      c[<span class="hljs-string">'_instance'</span>] = PUBNUB.init.apply PUBNUB, arguments
      c[<span class="hljs-string">'_channels'</span>] = []
      c[<span class="hljs-string">'_presence'</span>] = {}
      c[<span class="hljs-string">'_presData'</span>] = {}
      c[<span class="hljs-string">'_instance'</span>]</pre></div></div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Destroy the PubNub Angular library state. This is currently partial / best-effort because the vanilla PubNub library does not have a destroy method yet.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">destroy</span> = -&gt;</span>
      c[<span class="hljs-string">'_instance'</span>] = <span class="hljs-literal">null</span>
      c[<span class="hljs-string">'_channels'</span>] = <span class="hljs-literal">null</span>
      c[<span class="hljs-string">'_presence'</span>] = <span class="hljs-literal">null</span>
      c[<span class="hljs-string">'_presData'</span>] = <span class="hljs-literal">null</span></pre></div></div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO - destroy PUBNUB instance &amp; reset memory using PUBNUB’s destroy method when it’s available.</p>

            </div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Internal method that creates a message handler for a specified channel name. Uses a closure so that we capture the channel name within the message handler callback.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">_ngFireMessages</span> = <span class="hljs-params">(realChannel)</span> -&gt;</span>
      <span class="hljs-function"><span class="hljs-params">(messages, t1, t2)</span> -&gt;</span>
        c.each messages[<span class="hljs-number">0</span>], <span class="hljs-function"><span class="hljs-params">(message)</span> -&gt;</span>
          $rootScope.$broadcast <span class="hljs-string">"pn-message:<span class="hljs-subst">#{realChannel}</span>"</span>, {
            <span class="hljs-attribute">message</span>: message
            <span class="hljs-attribute">channel</span>: realChannel
          }</pre></div></div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Internal method that creates wrappers for the message and presence event handlers. Wrappers are necessary because we want the Angular library to keep track of channels and presence events on the application’s behalf.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">_ngInstallHandlers</span> = <span class="hljs-params">(args)</span> -&gt;</span>
      oldmessage = args.message</pre></div></div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Create a message handler wrapper that broadcasts the message event and calls the original user-provided message handler.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      args.<span class="hljs-function"><span class="hljs-title">message</span> = -&gt;</span>
        $rootScope.$broadcast c.ngMsgEv(args.channel), {
          <span class="hljs-attribute">message</span>: arguments[<span class="hljs-number">0</span>],
          <span class="hljs-attribute">env</span>: arguments[<span class="hljs-number">1</span>],
          <span class="hljs-attribute">channel</span>: args.channel
        }
        oldmessage(arguments) <span class="hljs-keyword">if</span> oldmessage</pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Create a presence handler wrapper that broadcasts the presence event and calls the original user-provided presence handler.</p>

            </div>

            <div class="content"><div class='highlight'><pre>      oldpresence = args.presence
      args.<span class="hljs-function"><span class="hljs-title">presence</span> = -&gt;</span>
        event = arguments[<span class="hljs-number">0</span>]
        channel = args.channel</pre></div></div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>We must handle two sources of presence data: <code>here_now</code> and <code>presence</code> events. The <code>here_now</code> events include a <code>uuids</code> field. Normal <code>presence</code> events have a <code>uuid</code> field and an <code>action</code> field (join or leave).</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> event.uuids
          c.each event.uuids, <span class="hljs-function"><span class="hljs-params">(uuid)</span> -&gt;</span>
            state = <span class="hljs-keyword">if</span> uuid.state <span class="hljs-keyword">then</span> uuid.state <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
            uuid  = <span class="hljs-keyword">if</span> uuid.uuid  <span class="hljs-keyword">then</span> uuid.uuid <span class="hljs-keyword">else</span> uuid
            c[<span class="hljs-string">'_presence'</span>][channel] ||= []
            c[<span class="hljs-string">'_presence'</span>][channel].push uuid <span class="hljs-keyword">if</span> c[<span class="hljs-string">'_presence'</span>][channel].indexOf(uuid) &lt; <span class="hljs-number">0</span>
            c[<span class="hljs-string">'_presData'</span>][channel] ||= {}
            c[<span class="hljs-string">'_presData'</span>][channel][uuid] = state <span class="hljs-keyword">if</span> state
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">if</span> event.uuid &amp;&amp; event.action
            c[<span class="hljs-string">'_presence'</span>][channel] ||= []
            c[<span class="hljs-string">'_presData'</span>][channel] ||= {}
            <span class="hljs-keyword">if</span> event.action == <span class="hljs-string">'leave'</span>
              cpos = c[<span class="hljs-string">'_presence'</span>][channel].indexOf event.uuid
              c[<span class="hljs-string">'_presence'</span>][channel].splice cpos, <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> cpos != -<span class="hljs-number">1</span>
              <span class="hljs-keyword">delete</span> c[<span class="hljs-string">'_presData'</span>][channel][event.uuid]
            <span class="hljs-keyword">else</span>
              c[<span class="hljs-string">'_presence'</span>][channel].push event.uuid <span class="hljs-keyword">if</span> c[<span class="hljs-string">'_presence'</span>][channel].indexOf(event.uuid) &lt; <span class="hljs-number">0</span>
              c[<span class="hljs-string">'_presData'</span>][channel][event.uuid] = event.data <span class="hljs-keyword">if</span> event.data

        $rootScope.$broadcast c.ngPrsEv(args.channel), {
          <span class="hljs-attribute">event</span>: event,
          <span class="hljs-attribute">message</span>: arguments[<span class="hljs-number">1</span>],
          <span class="hljs-attribute">channel</span>: channel
        }
        oldpresence(arguments) <span class="hljs-keyword">if</span> oldpresence

      args</pre></div></div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>The PubNub Angular API takes care of keeping track of currently subscribed channels. Call the <code>PubNub.ngListChannels()</code> method to return a list of presently subscribed channels.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngListChannels</span>  = -&gt;</span>
      c[<span class="hljs-string">'_channels'</span>].slice <span class="hljs-number">0</span></pre></div></div>

        </li>


        <li id="section-23">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>The PubNub Angular API takes care of keeping track of channel presence information. Call the <code>PubNub.ngListPresence(channel)</code> method to return a list of presently subscribed user uuids in the specified channel.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngListPresence</span> = <span class="hljs-params">(channel)</span> -&gt;</span>
      c[<span class="hljs-string">'_presence'</span>][channel]?.slice <span class="hljs-number">0</span></pre></div></div>

        </li>


        <li id="section-24">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>It’s also possible to retrieve the extended Presence state data for users in a channel using the <code>PubNub.ngPresenceData(channel)</code> function. Returns a map of UUID to state data.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngPresenceData</span> = <span class="hljs-params">(channel)</span> -&gt;</span> c[<span class="hljs-string">'_presData'</span>][channel] || {}</pre></div></div>

        </li>


        <li id="section-25">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Subscribing to channels is accomplished by calling the PubNub <a href="http://www.pubnub.com/docs/javascript/api/reference.html#subscribe"><code>ngSubscribe</code></a> method. After the channel is subscribed, the app can register root scope message events by calling <code>$rootScope.$on</code> with the event string returned by <code>PubNub.ngMsgEv(channel)</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngSubscribe</span> = <span class="hljs-params">(args)</span> -&gt;</span>
      c[<span class="hljs-string">'_channels'</span>].push args.channel <span class="hljs-keyword">if</span> c[<span class="hljs-string">'_channels'</span>].indexOf(args.channel) &lt; <span class="hljs-number">0</span>
      c[<span class="hljs-string">'_presence'</span>][args.channel] ||= []
      args = c._ngInstallHandlers args
      c.jsapi.subscribe(args)</pre></div></div>

        </li>


        <li id="section-26">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Unsubscribing is as easy as calling the <a href="http://www.pubnub.com/docs/javascript/api/reference.html#unsubscribe"><code>PubNub.ngUnsubscribe()</code></a> method. The library even takes care of removing the Angular event handlers for you to prevent unsightly memory leaks!</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngUnsubscribe</span> = <span class="hljs-params">(args)</span> -&gt;</span>
      cpos = c[<span class="hljs-string">'_channels'</span>].indexOf(args.channel)
      c[<span class="hljs-string">'_channels'</span>].splice cpos, <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> cpos != -<span class="hljs-number">1</span>
      c[<span class="hljs-string">'_presence'</span>][args.channel] = <span class="hljs-literal">null</span>
      <span class="hljs-keyword">delete</span> $rootScope.$$listeners[c.ngMsgEv(args.channel)]
      <span class="hljs-keyword">delete</span> $rootScope.$$listeners[c.ngPrsEv(args.channel)]
      c.jsapi.unsubscribe(args)</pre></div></div>

        </li>


        <li id="section-27">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Publishing to channels is trivial - just use the <a href="http://www.pubnub.com/docs/javascript/api/reference.html#publish"><code>PubNub.ngPublish()</code></a> method.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngPublish</span> = -&gt;</span> c[<span class="hljs-string">'_instance'</span>][<span class="hljs-string">'publish'</span>].apply c[<span class="hljs-string">'_instance'</span>], arguments</pre></div></div>

        </li>


        <li id="section-28">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>It can be super-handy to gather the previous several hundred messages from the PubNub channel <a href="http://www.pubnub.com/docs/javascript/api/reference.html#history">history</a>. The PubNub Angular API makes this easy by bridging the event model of the PubNub JS history API and the AngularJS event broadcast model so that historical messages come through the same event interface.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngHistory</span> = <span class="hljs-params">(args)</span> -&gt;</span></pre></div></div>

        </li>


        <li id="section-29">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO: in the next API version, save &amp; restore the callback</p>

            </div>

            <div class="content"><div class='highlight'><pre>      args.callback = c._ngFireMessages args.channel
      c.jsapi.history args</pre></div></div>

        </li>


        <li id="section-30">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Sometimes, it’s better to retrieve history as a promise. The ‘ngHistoryQ’ method returns a promise that is fulfilled when the history call returns. More about <a href="http://www.pubnub.com/docs/javascript/api/reference.html#history">history</a>. This method does not send historical events through the root scope event mechanism.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngHistoryQ</span> = <span class="hljs-params">(args)</span> -&gt;</span>
      deferred = $q.defer()
      oldcallback = args.callback
      args.<span class="hljs-function"><span class="hljs-title">callback</span> = <span class="hljs-params">(x)</span> -&gt;</span>
        deferred.resolve(x)
        $rootScope.$apply()
        oldcallback(x) <span class="hljs-keyword">if</span> oldcallback
      args.<span class="hljs-function"><span class="hljs-title">error</span> = <span class="hljs-params">(x)</span> -&gt;</span>
        deferred.reject(x)
      c[<span class="hljs-string">'jsapi'</span>][<span class="hljs-string">'history'</span>].apply c[<span class="hljs-string">'_instance'</span>], [args]
      deferred.promise</pre></div></div>

        </li>


        <li id="section-31">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>It’s also easy to integrate presence events using the Angular API. In the example above, we just add an additional couple lines of code to call the <a href="http://www.pubnub.com/docs/javascript/api/reference.html#here_now"><code>PubNub.ngHereNow()</code></a> method (retrieve current users in a channel).</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngHereNow</span> = <span class="hljs-params">(args)</span> -&gt;</span>
      args = c._ngInstallHandlers(args)
      args.state = <span class="hljs-literal">true</span>
      args.callback = args.presence
      <span class="hljs-keyword">delete</span> args.presence
      <span class="hljs-keyword">delete</span> args.message
      c.jsapi.here_now(args)</pre></div></div>

        </li>


        <li id="section-32">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>You can obtain information about the current list of a channels to which a uuid is subscribed to by calling the <code>ngWhereNow()</code> function in your application. <a href="http://www.pubnub.com/docs/javascript/api/reference.html#where_now">More info on ngWhereNow</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngWhereNow</span> = <span class="hljs-params">(args)</span> -&gt;</span> c.jsapi.where_now(args)</pre></div></div>

        </li>


        <li id="section-33">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>You can obtain information about the current metadata associated with a uuid by calling the <code>ngState()</code> function in your application. <a href="http://www.pubnub.com/docs/javascript/api/reference.html#state">More info on ngState</a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngState</span>    = <span class="hljs-params">(args)</span> -&gt;</span> c.jsapi.state(args)</pre></div></div>

        </li>


        <li id="section-34">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Each channel has a unique “message event name” for message events. The method <code>ngMsgEv(channel)</code> returns that broadcast event name for message events for a given channel as they are broadcast via <code>$rootScope</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngMsgEv</span> = <span class="hljs-params">(channel)</span> -&gt;</span> <span class="hljs-string">"pn-message:<span class="hljs-subst">#{channel}</span>"</span></pre></div></div>

        </li>


        <li id="section-35">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Each channel has a unique “presence event name” for presence events. The method <code>ngPrsEv(channel)</code> returns that broadcast event name for presence events for a given channel as they are broadcast via <code>$rootScope</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngPrsEv</span> = <span class="hljs-params">(channel)</span> -&gt;</span> <span class="hljs-string">"pn-presence:<span class="hljs-subst">#{channel}</span>"</span></pre></div></div>

        </li>


        <li id="section-36">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>The method <a href="http://www.pubnub.com/docs/javascript/api/reference.html#auth"><code>ngAuth</code></a> updates the auth_key associated with the PubNub session.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngAuth</span>   = -&gt;</span> c[<span class="hljs-string">'_instance'</span>][<span class="hljs-string">'auth'</span>].apply c[<span class="hljs-string">'_instance'</span>], arguments</pre></div></div>

        </li>


        <li id="section-37">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Often times, it’s desirable to lock down applications and channels. With PAM (PubNub Access Manager), it’s easy. There are 2 calls: <a href="http://www.pubnub.com/docs/javascript/api/reference.html#grant"><code>ngGrant</code></a> which grants access for users having a specified auth key, and <a href="http://www.pubnub.com/docs/javascript/api/reference.html#audit"><code>ngAudit</code></a> which returns the current policy configuration. Note: to perform access control operations, the PubNub client must be initialized with the secret key (which should always be protected by server-only access).</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.<span class="hljs-function"><span class="hljs-title">ngAudit</span>  = -&gt;</span> c[<span class="hljs-string">'_instance'</span>][<span class="hljs-string">'audit'</span>].apply c[<span class="hljs-string">'_instance'</span>], arguments
    c.<span class="hljs-function"><span class="hljs-title">ngGrant</span>  = -&gt;</span> c[<span class="hljs-string">'_instance'</span>][<span class="hljs-string">'grant'</span>].apply c[<span class="hljs-string">'_instance'</span>], arguments</pre></div></div>

        </li>


        <li id="section-38">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>PubNub DataSync BETA</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA = {}

    <span class="hljs-function"><span class="hljs-title">_makeDataSyncOperation</span> = <span class="hljs-params">(op)</span> -&gt;</span> <span class="hljs-function"><span class="hljs-params">(args)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> args &amp;&amp; args[<span class="hljs-string">'object_id'</span>]
      deferred = $q.defer()
      oldcallback = args.callback
      args.<span class="hljs-function"><span class="hljs-title">callback</span> = <span class="hljs-params">(x)</span> -&gt;</span>
        deferred.resolve(x)
        $rootScope.$apply()
        oldcallback(x) <span class="hljs-keyword">if</span> oldcallback
      args.<span class="hljs-function"><span class="hljs-title">error</span> = <span class="hljs-params">(x)</span> -&gt;</span>
        deferred.reject(x)
      c[<span class="hljs-string">'jsapi'</span>][op].apply c[<span class="hljs-string">'_instance'</span>], [args]
      deferred.promise</pre></div></div>

        </li>


        <li id="section-39">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Get Object. Returns a $q promise</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.ngGet = _makeDataSyncOperation(<span class="hljs-string">'get'</span>)</pre></div></div>

        </li>


        <li id="section-40">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Set Object. Returns a $q promise</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.ngSet = _makeDataSyncOperation(<span class="hljs-string">'set'</span>)</pre></div></div>

        </li>


        <li id="section-41">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Merge Object. Returns a $q promise</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.ngMerge = _makeDataSyncOperation(<span class="hljs-string">'merge'</span>)</pre></div></div>

        </li>


        <li id="section-42">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Remove Object. Returns a $q promise</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.ngRemove = _makeDataSyncOperation(<span class="hljs-string">'remove'</span>)</pre></div></div>

        </li>


        <li id="section-43">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Internal use only. Creates a callback for sync events</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">_syncCallback</span> = <span class="hljs-params">(name, object_id, path)</span> -&gt;</span> <span class="hljs-function"><span class="hljs-params">(r)</span> -&gt;</span>
      $rootScope.$broadcast(c.datasync_BETA.ngObjPathRecEv(object_id, path), {
        <span class="hljs-attribute">action</span>: name
        object_id : object_id
        path : path
        payload : r
      })
      $rootScope.$apply()</pre></div></div>

        </li>


        <li id="section-44">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Sync object. Retrieves the specified object and metadata, with live updates and Angular $broadcast events enabled. NOTE: only one of ‘ngSync’ or ‘ngWatch’ may be used for a given object. Using both appears to corrupt the connection.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.<span class="hljs-function"><span class="hljs-title">ngSync</span> = <span class="hljs-params">(object_id)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> object_id
      result = c[<span class="hljs-string">'jsapi'</span>][<span class="hljs-string">'sync'</span>].apply c[<span class="hljs-string">'_instance'</span>], [object_id]
      [<span class="hljs-string">'ready'</span>,<span class="hljs-string">'change'</span>,<span class="hljs-string">'update'</span>,<span class="hljs-string">'remove'</span>,<span class="hljs-string">'set'</span>,<span class="hljs-string">'error'</span>].forEach <span class="hljs-function"><span class="hljs-params">(x)</span> -&gt;</span> result.<span class="hljs-literal">on</span>[x](_syncCallback(x, object_id, <span class="hljs-literal">null</span>))
      [<span class="hljs-string">'connect'</span>,<span class="hljs-string">'disconnect'</span>,<span class="hljs-string">'reconnect'</span>].forEach <span class="hljs-function"><span class="hljs-params">(x)</span> -&gt;</span> result.<span class="hljs-literal">on</span>.network[x](_syncCallback(x, object_id, <span class="hljs-literal">null</span>))
      result</pre></div></div>

        </li>


        <li id="section-45">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: $rootScope broadcast event name for object/path combination</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.<span class="hljs-function"><span class="hljs-title">ngObjPathEv</span>      = <span class="hljs-params">(object_id, path)</span> -&gt;</span> <span class="hljs-string">'pn-datasync-obj:'</span> + c.datasync_BETA.ngObjPathChan(object_id, path)</pre></div></div>

        </li>


        <li id="section-46">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: $rootScope broadcast event name for recursive object/path combination</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.<span class="hljs-function"><span class="hljs-title">ngObjPathRecEv</span>   = <span class="hljs-params">(object_id, path)</span> -&gt;</span> <span class="hljs-string">'pn-datasync-obj-rec:'</span> + c.datasync_BETA.ngObjPathRecChan(object_id, path)</pre></div></div>

        </li>


        <li id="section-47">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: $rootScope broadcast event name for object datastore operations</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.<span class="hljs-function"><span class="hljs-title">ngObjDsEv</span>        = <span class="hljs-params">(object_id)</span>       -&gt;</span> <span class="hljs-string">'pn-datasync-obj-ds:'</span> + c.datasync_BETA.ngObjDsChan(object_id)</pre></div></div>

        </li>


        <li id="section-48">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Watch an object. Events are broadcast on $rootScope. NOTE: only one of ‘ngSync’ or ‘ngWatch’ may be used for a given object. Using both appears to corrupt the connection.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.<span class="hljs-function"><span class="hljs-title">ngWatch</span> = <span class="hljs-params">(args)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> args &amp;&amp; args[<span class="hljs-string">'object_id'</span>]
      object_id = args[<span class="hljs-string">'object_id'</span>]
      path      = args[<span class="hljs-string">'path'</span>]
      datastore = { chan : c.datasync_BETA.ngObjDsChan(object_id), ev : c.datasync_BETA.ngObjDsEv(object_id) }
      object_ds = { chan : c.datasync_BETA.ngObjPathChan(object_id, path), ev : c.datasync_BETA.ngObjPathEv(object_id, path) }
      object_ds_rec = { chan : c.datasync_BETA.ngObjPathRecChan(object_id, path), ev : c.datasync_BETA.ngObjPathRecEv(object_id, path) }
      oldcallback = args.callback
      [object_ds, object_ds_rec, datastore].forEach <span class="hljs-function"><span class="hljs-params">(cfg)</span> -&gt;</span>
        <span class="hljs-function"><span class="hljs-params">((chan, ev) -&gt;
          args.channel = chan
          args.callback = (o) -&gt;
            payload = {
              event: ev
              channel: chan
              object_id : object_id
              path : path
              payload : o
            }
            $rootScope.$broadcast(ev, payload)
            oldcallback(payload) <span class="hljs-keyword">if</span> oldcallback
          c[<span class="hljs-string">'jsapi'</span>][<span class="hljs-string">'subscribe'</span>].apply c[<span class="hljs-string">'_instance'</span>], [args]
        )(cfg.chan, cfg.ev)</span>

</span></pre></div></div>

        </li>


        <li id="section-49">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Internal use only. Channel Name for object/path combination</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.<span class="hljs-function"><span class="hljs-title">ngObjPathChan</span>    = <span class="hljs-params">(object_id, path)</span> -&gt;</span> <span class="hljs-string">'pn_ds_'</span> + object_id + (<span class="hljs-keyword">if</span> path <span class="hljs-keyword">then</span> <span class="hljs-string">'.'</span> + path <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>)</pre></div></div>

        </li>


        <li id="section-50">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Internal use only. Channel Name for recursive object/path combination</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.<span class="hljs-function"><span class="hljs-title">ngObjPathRecChan</span> = <span class="hljs-params">(object_id, path)</span> -&gt;</span> c.datasync_BETA.ngObjPathChan(object_id, path) + <span class="hljs-string">'.*'</span></pre></div></div>

        </li>


        <li id="section-51">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>PubNub DataSync BETA: Internal use only. Channel Name for object data store operations</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c.datasync_BETA.<span class="hljs-function"><span class="hljs-title">ngObjDsChan</span>      = <span class="hljs-params">(object_id)</span>       -&gt;</span> <span class="hljs-string">'pn_dstr_'</span> + object_id</pre></div></div>

        </li>


        <li id="section-52">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>… And we’re done! We return this object as the PubNub AngularJS service instance.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    c
  ]</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
